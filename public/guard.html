<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGate Guard - Live Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="manifest" href="./manifest.json">
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: 'Inter', sans-serif; }
        /* Í∏¥Í∏â ÏïåÎûå Ïä§ÌÉÄÏùº */
        .alert-card {
            background: #3d080b;
            border-left: 10px solid #ff4444;
            border-radius: 15px;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        /* ÌÖåÏù¥Î∏î Ïä§ÌÉÄÏùº */
        .visitor-table-container { background: #1e1e1e; border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .table { color: #e0e0e0; margin-bottom: 0; }
        .table thead { background: #2c2c2c; border-bottom: 2px solid #444; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        #loadingOverlay.hidden { display: none; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<nav class="navbar navbar-dark bg-black shadow-sm mb-4">
    <div class="container-fluid px-4">
        <span class="navbar-brand fw-bold text-primary">üõ°Ô∏è SafeGate GUARD</span>
        <div class="d-flex align-items-center">
            <div id="connStatus" class="me-3 small text-muted">Connecting...</div>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <section class="mb-5">
        <h4 class="fw-bold text-danger mb-3 d-flex align-items-center">
            <span class="spinner-grow spinner-grow-sm text-danger me-2"></span>
            üö® EMERGENCY ALERTS
        </h4>
        <div id="alertList" class="row g-3">
            <div id="emptyAlertMsg" class="text-center py-4 border border-secondary border-dashed rounded opacity-50">
                <p class="mb-0">No active security threats detected.</p>
            </div>
        </div>
    </section>

    <hr class="border-secondary my-5">

    <section>
        <div class="d-flex justify-content-between align-items-end mb-3">
            <h4 class="fw-bold text-info mb-0">üìÖ Today's Visitors</h4>
            <span id="visitorCount" class="badge bg-info text-dark">0 Total</span>
        </div>
        
        <div class="visitor-table-container shadow">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th style="width: 20%;">Time</th>
                            <th style="width: 25%;">Name</th>
                            <th style="width: 25%;">Contact</th>
                            <th style="width: 30%;">Purpose</th>
                        </tr>
                    </thead>
                    <tbody id="visitorList">
                        <tr>
                            <td colspan="4" class="text-center py-5 text-muted">Waiting for today's visitors...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        collection, query, orderBy, onSnapshot, limit, doc, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Ïù∏Ï¶ù Î∞è Í∂åÌïú ÏÉÅÌÉú Í∞êÏãú ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html";
            return;
        }
        
        try {
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && (userDoc.data().role === 'guard' || userDoc.data().role === 'admin')) {
                initGuardSystem();
            } else {
                alert("Guard access only.");
                signOut(auth);
            }
        } catch (err) {
            console.error("Auth check failed:", err);
        } finally {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    });

    function initGuardSystem() {
        initAlertListener();
        initTodayVisitorsListener();
    }

    // --- 1. Í∏¥Í∏â ÏïåÎûå Î¶¨Ïä§ÎÑà ---
    function initAlertListener() {
        const alertContainer = document.getElementById('alertList');
        // alerts Ïª¨Î†âÏÖòÏóê ÏÉà Î¨∏ÏÑúÍ∞Ä Ï∂îÍ∞ÄÎê† ÎïåÎßàÎã§ Ï¶âÏãú Î∞òÏùë
        const q = query(collection(db, "alerts"), orderBy("timestamp", "desc"), limit(5));

        onSnapshot(q, (snapshot) => {
            document.getElementById('connStatus').innerHTML = `<span class="status-dot bg-success"></span>Online`;

            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const emptyMsg = document.getElementById('emptyAlertMsg');
                    if (emptyMsg) emptyMsg.remove();

                    const data = change.doc.data();
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : 'Now';

                    const card = document.createElement('div');
                    card.className = "col-12 animate-slide-in";
                    card.innerHTML = `
                        <div class="card alert-card p-4 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="text-white fw-bold mb-0">üö´ BANNED PERSON</h3>
                                <span class="badge bg-danger">${time}</span>
                            </div>
                            <div class="mt-3 fs-2 fw-bold text-white">${data.name}</div>
                            <div class="fs-4 text-warning">${data.contact}</div>
                            <div class="mt-2 small text-light opacity-75">üìç ${data.barangay}, ${data.city} | Purpose: ${data.purpose}</div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    alertContainer.prepend(card);
                    
                    // ÏÇ¨Ïù¥Î†å ÏÜåÎ¶¨ Ïû¨ÏÉù ÏãúÎèÑ
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(() => {});
                }
            });
        });
    }

    // --- 2. Ïò§Îäò Î∞©Î¨∏Ïûê Î¶¨Ïä§Ìä∏ Î¶¨Ïä§ÎÑà (Í∞ïÌôîÎêú Î≤ÑÏ†Ñ) ---
    function initTodayVisitorsListener() {
        const visitorTable = document.getElementById('visitorList');
        const countBadge = document.getElementById('visitorCount');

        // Ïò§Îäò ÎÇ†Ïßú 00:00:00 Í∏∞Ï§Ä ÏãúÍ∞Ñ ÏÑ§Ï†ï
        const todayStart = new Date();
        todayStart.setHours(0, 0, 0, 0);

        // Î≥µÌï© ÏøºÎ¶¨ ÏÉâÏù∏ ÏóêÎü¨ Î∞©ÏßÄÎ•º ÏúÑÌï¥ orderByÎßå ÏÇ¨Ïö©ÌïòÍ≥† ÌïÑÌÑ∞ÎßÅÏùÄ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú ÏàòÌñâ
        const q = query(collection(db, "visitors"), orderBy("timestamp", "desc"), limit(100));

        onSnapshot(q, (snapshot) => {
            visitorTable.innerHTML = ''; 
            let todayCount = 0;

            snapshot.forEach((doc) => {
                const data = doc.data();
                const visitDate = data.timestamp ? data.timestamp.toDate() : null;

                // Ïò§Îäò Î∞©Î¨∏Ìïú Îç∞Ïù¥ÌÑ∞Îßå Í≥®ÎùºÎÇ¥Í∏∞
                if (visitDate && visitDate >= todayStart) {
                    todayCount++;
                    const time = visitDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-info">${time}</td>
                        <td class="fw-bold">${data.name}</td>
                        <td>${data.contact}</td>
                        <td><span class="badge bg-secondary opacity-75">${data.purpose}</span></td>
                    `;
                    visitorTable.appendChild(tr);
                }
            });

            countBadge.innerText = `${todayCount} Today`;
            
            if (todayCount === 0) {
                visitorTable.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">No visitors registered today.</td></tr>';
            }
        }, (error) => {
            console.error("Visitor list error:", error);
            // Index ÏóêÎü¨ Ïãú ÏΩòÏÜîÏùò ÎßÅÌÅ¨Î•º ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉâÏù∏ ÏÉùÏÑ± ÌïÑÏàò
        });
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>

</body>
</html>
