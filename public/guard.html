<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGate Guard - Live Monitoring</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="manifest" href="./manifest.json">
    <style>
        body { background-color: #121212; color: #e0e0e0; }
        /* ì‹¤ì‹œê°„ ê¸´ê¸‰ ì•ŒëŒ ìŠ¤íƒ€ì¼ */
        .alert-card {
            background: #3d080b;
            border-left: 10px solid #ff4444;
            border-radius: 15px;
            animation: pulse-red 2s infinite;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(255, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); }
        }
        /* ì¼ë°˜ ë°©ë¬¸ì ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .visitor-table { background: #1e1e1e; border-radius: 10px; overflow: hidden; }
        .table { color: #e0e0e0; margin-bottom: 0; }
        .table thead { background: #2c2c2c; }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        #loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #121212; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        #loadingOverlay.hidden { display: none; }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<nav class="navbar navbar-dark bg-black shadow-sm mb-4">
    <div class="container-fluid">
        <span class="navbar-brand fw-bold text-primary">ğŸ›¡ï¸ SafeGate GUARD</span>
        <div class="d-flex align-items-center">
            <div id="connStatus" class="me-3 small text-muted">Connecting...</div>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>
    </div>
</nav>

<div class="container pb-5">
    <section class="mb-5">
        <h4 class="fw-bold text-danger mb-3">ğŸš¨ EMERGENCY ALERTS</h4>
        <div id="alertList" class="row g-3">
            <div id="emptyAlertMsg" class="text-center py-4 border border-secondary border-dashed rounded opacity-50">
                <p class="mb-0">No active security threats detected.</p>
            </div>
        </div>
    </section>

    <hr class="border-secondary my-4">

    <section>
        <div class="d-flex justify-content-between align-items-end mb-3">
            <h4 class="fw-bold text-info mb-0">ğŸ“… Today's Visitors</h4>
            <span id="visitorCount" class="badge bg-info text-dark">0 Total</span>
        </div>
        
        <div class="visitor-table shadow">
            <div class="table-responsive">
                <table class="table table-dark table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Purpose</th>
                        </tr>
                    </thead>
                    <tbody id="visitorList">
                        <tr>
                            <td colspan="4" class="text-center py-4 text-muted">No visitors registered today.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>
</div>

<script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        collection, query, orderBy, onSnapshot, where, Timestamp 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- ì¸ì¦ ìƒíƒœ í™•ì¸ ---
    onAuthStateChanged(auth, (user) => {
        if (!user) {
            window.location.href = "index.html";
        } else {
            initSystem();
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
    });

    function initSystem() {
        // 1. ì‹¤ì‹œê°„ ê¸´ê¸‰ ì•ŒëŒ ë¦¬ìŠ¤ë„ˆ (Banned Persons)
        initAlertListener();
        // 2. ì˜¤ëŠ˜ ë°©ë¬¸ì ë¦¬ìŠ¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (General Visitors)
        initTodayVisitorsListener();
    }

    // --- [ê¸°ëŠ¥ 1] ì‹¤ì‹œê°„ ê¸´ê¸‰ ì•ŒëŒ ë¦¬ìŠ¤ë„ˆ ---
    function initAlertListener() {
        const alertContainer = document.getElementById('alertList');
        const q = query(collection(db, "alerts"), orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            document.getElementById('connStatus').innerHTML = `<span class="status-dot bg-success"></span>Online`;

            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const emptyMsg = document.getElementById('emptyAlertMsg');
                    if (emptyMsg) emptyMsg.remove();

                    const data = change.doc.data();
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : 'Now';

                    const card = document.createElement('div');
                    card.className = "col-12";
                    card.innerHTML = `
                        <div class="card alert-card p-4 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <h3 class="text-white fw-bold mb-0">ğŸš« BANNED PERSON</h3>
                                <span class="badge bg-danger">${time}</span>
                            </div>
                            <div class="mt-3 fs-2 fw-bold text-white">${data.name}</div>
                            <div class="fs-4 text-warning">${data.contact}</div>
                            <div class="mt-2 small text-light opacity-75">ğŸ“ ${data.barangay}, ${data.city} | Purpose: ${data.purpose}</div>
                            <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="alert"></button>
                        </div>
                    `;
                    alertContainer.prepend(card);
                    
                    // ì‚¬ì´ë Œ ì†Œë¦¬ ì¬ìƒ
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(() => {});
                }
            });
        });
    }

    // --- [ê¸°ëŠ¥ 2] ì˜¤ëŠ˜ ë°©ë¬¸ì ì‹¤ì‹œê°„ ë¦¬ìŠ¤íŠ¸ ---
    function initTodayVisitorsListener() {
        const visitorTable = document.getElementById('visitorList');
        const countBadge = document.getElementById('visitorCount');

        // ì˜¤ëŠ˜ 00:00:00 íƒ€ì„ìŠ¤íƒ¬í”„ ê³„ì‚°
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const startOfToday = Timestamp.fromDate(today);

        const q = query(
            collection(db, "visitors"), 
            where("timestamp", ">=", startOfToday),
            orderBy("timestamp", "desc")
        );

        onSnapshot(q, (snapshot) => {
            visitorTable.innerHTML = ''; // í…Œì´ë¸” ì´ˆê¸°í™”
            countBadge.innerText = `${snapshot.size} Total`;

            if (snapshot.empty) {
                visitorTable.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No visitors registered today.</td></tr>';
                return;
            }

            snapshot.forEach((doc) => {
                const data = doc.data();
                const time = data.timestamp ? data.timestamp.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '---';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-info">${time}</td>
                    <td class="fw-bold">${data.name}</td>
                    <td>${data.contact}</td>
                    <td><span class="badge bg-secondary">${data.purpose}</span></td>
                `;
                visitorTable.appendChild(tr);
            });
        }, (error) => {
            console.error("Visitors Listener failed:", error);
            // ë§Œì•½ 'The query requires an index' ì—ëŸ¬ê°€ ë‚˜ë©´ ì½˜ì†” ë§í¬ë¥¼ í´ë¦­í•´ ìƒ‰ì¸ì„ ë§Œë“¤ì–´ì•¼ í•©ë‹ˆë‹¤.
        });
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>

</body>
</html>
