<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGate Guard - Live Alerts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <link rel="manifest" href="./manifest.json">
</head>
<body class="bg-dark text-white">

<div id="loadingOverlay">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<nav class="navbar navbar-dark bg-black shadow-sm mb-4">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">ğŸ›¡ï¸ SafeGate GUARD</span>
        <div class="d-flex align-items-center">
            <span id="userEmail" class="small me-3 text-muted"></span>
            <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
        </div>
    </div>
</nav>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="fw-bold text-info">Live Security Alerts</h4>
        <div id="connectionStatus" class="badge bg-secondary">Connecting...</div>
    </div>

    <div id="alertList" class="row row-cols-1 g-3">
        <div class="text-center py-5 text-muted" id="emptyMsg">
            <p class="fs-4">ğŸ“¡ Monitoring System Active...</p>
            <p>Waiting for incoming visitor data.</p>
        </div>
    </div>
</div>

<script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { 
        collection, query, orderBy, onSnapshot, doc, getDoc 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const loader = document.getElementById('loadingOverlay');
    const alertList = document.getElementById('alertList');
    const statusBadge = document.getElementById('connectionStatus');

    // --- ì¸ì¦ í™•ì¸ ë° ê°€ë“œ ê¶Œí•œ ì²´í¬ ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = "index.html"; // ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
            return;
        }

        try {
            const userRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userRef);

            if (userDoc.exists() && (userDoc.data().role === 'guard' || userDoc.data().role === 'admin')) {
                document.getElementById('userEmail').innerText = user.email;
                initAlertListener(); // ì•ŒëŒ ë¦¬ìŠ¤ë„ˆ ì‹¤í–‰
            } else {
                alert("Access Denied: You do not have Guard permissions.");
                signOut(auth);
            }
        } catch (err) {
            console.error("Auth check failed:", err);
        } finally {
            loader.classList.add('hidden');
        }
    });

    // --- ì‹¤ì‹œê°„ ì•Œë¦¼ ë¦¬ìŠ¤ë„ˆ (í•µì‹¬) ---
    function initAlertListener() {
        console.log("Initializing Security Listener...");
        
        // Alerts ì»¬ë ‰ì…˜ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì‹¤ì‹œê°„ ê°ì‹œ
        const q = query(collection(db, "alerts"), orderBy("timestamp", "desc"));

        onSnapshot(q, (snapshot) => {
            statusBadge.innerText = "Online";
            statusBadge.className = "badge bg-success";

            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    // ì²« ì•Œë¦¼ ì‹œ ëŒ€ê¸° ë©”ì‹œì§€ ì‚­ì œ
                    const emptyMsg = document.getElementById('emptyMsg');
                    if (emptyMsg) emptyMsg.remove();

                    const data = change.doc.data();
                    const entryTime = data.timestamp ? data.timestamp.toDate().toLocaleTimeString() : 'Now';

                    // ì•Œë¦¼ ì¹´ë“œ ìƒì„±
                    const div = document.createElement('div');
                    div.className = "alert alert-danger shadow-lg p-4 mb-3 border-start border-5 border-danger animate-slide-in";
                    div.style.background = "#2c1010"; // ì–´ë‘ìš´ ë ˆë“œ ë°°ê²½
                    div.style.color = "#ffc1c1";
                    
                    div.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <h4 class="fw-bold mb-1">ğŸš« BANNED VISITOR DETECTED</h4>
                            <span class="badge bg-danger">${entryTime}</span>
                        </div>
                        <div class="fs-4 mt-2"><strong>Name:</strong> ${data.name}</div>
                        <div class="fs-5"><strong>Contact:</strong> ${data.contact}</div>
                        <div class="mt-2 small opacity-75">Address: ${data.barangay}, ${data.city}</div>
                        <div class="mt-2 fw-bold text-warning">Purpose: ${data.purpose}</div>
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3" data-bs-dismiss="alert"></button>
                    `;
                    
                    alertList.prepend(div);

                    // ê°•ë ¥í•œ ì†Œë¦¬ ì•Œë¦¼
                    playAlertSound();
                }
            });
        }, (error) => {
            console.error("Listener Error:", error);
            statusBadge.innerText = "Offline/Error";
            statusBadge.className = "badge bg-danger";
        });
    }

    function playAlertSound() {
        // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ ì¬ìƒ ê°€ëŠ¥
        const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');
        audio.play().catch(e => console.log("Sound play blocked until first tap."));
    }

    document.getElementById('logoutBtn').onclick = () => signOut(auth);
</script>

<style>
    .animate-slide-in {
        animation: slideIn 0.5s ease-out;
    }
    @keyframes slideIn {
        from { transform: translateY(-20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    /* ê°€ë“œìš© ì–´ë‘ìš´ í…Œë§ˆ ë³´ì • */
    .alert-danger .btn-close { filter: invert(1); }
</style>

</body>
</html>
