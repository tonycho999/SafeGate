<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafeGate - Manage Ban List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>ðŸš« Blacklist Management</h2>
        <a href="index.html" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>

    <div class="card p-4 shadow-sm mb-4">
        <form id="banForm" class="row g-3">
            <div class="col-md-5">
                <input type="text" id="banName" class="form-control" placeholder="Full Name" required>
            </div>
            <div class="col-md-5">
                <input type="tel" id="banContact" class="form-control" placeholder="Contact Number" required>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-danger w-100">Add to List</button>
            </div>
        </form>
    </div>

    <div class="card shadow-sm">
        <table class="table table-hover mb-0">
            <thead class="table-dark">
                <tr>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="banTableBody">
                </tbody>
        </table>
    </div>
</div>

<script type="module">
    import { auth, db } from "./js/firebase-config.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { collection, addDoc, getDocs, deleteDoc, doc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ì¸ì¦ í™•ì¸
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        loadBanList();
    });

    const banForm = document.getElementById('banForm');
    const banTable = document.getElementById('banTableBody');

    // 1. ì°¨ë‹¨ ëª©ë¡ ì¶”ê°€ ë¡œì§
    banForm.onsubmit = async (e) => {
        e.preventDefault();
        const name = document.getElementById('banName').value.trim();
        const contact = document.getElementById('banContact').value.trim();

        try {
            // [ì¤‘ìš”] ban_list ì»¬ë ‰ì…˜ì— ì¶”ê°€
            await addDoc(collection(db, "ban_list"), {
                name: name,
                contact: contact,
                createdAt: new Date()
            });
            alert("Successfully added to blacklist.");
            banForm.reset();
        } catch (error) {
            console.error("Add failed:", error);
            alert("Error: Only admins can manage this list. Check Firebase Rules.");
        }
    };

    // 2. ì‹¤ì‹œê°„ ëª©ë¡ ë¡œë“œ ë° ì‚­ì œ ë¡œì§
    function loadBanList() {
        onSnapshot(collection(db, "ban_list"), (snapshot) => {
            banTable.innerHTML = '';
            snapshot.forEach((docSnap) => {
                const data = docSnap.data();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${data.name}</td>
                    <td>${data.contact}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteBan('${docSnap.id}')">Remove</button></td>
                `;
                banTable.appendChild(tr);
            });
        });
    }

    // ì‚­ì œ í•¨ìˆ˜ ì—°ê²°
    window.deleteBan = async (id) => {
        if(confirm("Remove this person from blacklist?")) {
            await deleteDoc(doc(db, "ban_list", id));
        }
    };
</script>
</body>
</html>
